<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>活动详情</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no" />
    <script src="https://cdn.bootcss.com/vue/2.5.13/vue.min.js" charset="utf-8"></script>
    <script src="https://cdn.bootcss.com/vue-resource/1.5.0/vue-resource.js"></script>
    <script src="https://unpkg.com/mint-ui/lib/index.js"></script>
    <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js"></script>
    <link rel="stylesheet" href="find_specialist.css" />
</head>
<body>
<div class="all" id="app">
    <div class="wrapper">
        <div class="top">
            <img src="https://cdn.juliye.net/2030_act_character@3x.png">
        </div>
        <div class="center_form">
            <div class="form_item">
                <div class="form_title">姓名</div>
                <div class="form_input"><input class="input_sp" type="text" v-model="postData.name" placeholder="请填写"/></div>
            </div>
            <div class="form_item">
                <div class="form_title">手机号</div>
                <div class="form_input"><input class="input_sp" type="number" v-model="postData.phone" placeholder="请填写" maxlength="11"/></div>
            </div>
            <div class="form_item">
                <div class="form_title">病种</div>
                <div class="form_input">
                    <select class="select_style" v-model="postData.diseases" @change="changeDis(postData.diseases)">
                        <option disabled value="">请选择</option>
                        <option v-for="item in diseases" :value="item">{{item}}</option>
                    </select>
                </div>
                <div class="other" v-if="isOther">
                    <input class="input_sp" type="text" v-model="other_diseases" placeholder="请填写"/>
                </div>
            </div>
            <div class="form_item">
                <div class="form_title">所需服务</div>
                <div class="form_input">
                    <select class="select_style" v-model="postData.services" @change="changeSer(postData.services)">
                        <option disabled value="">请选择</option>
                        <option v-for="item in services" :value="item">{{item}}</option>
                    </select>
                </div>
                <div class="other" v-if="isOther2">
                    <input class="input_sp" type="text" v-model="other_services" placeholder="请填写"/>
                </div>
            </div>
            <div class="submit" @click="upload" v-if="!once">提交</div>
            <div class="btn_no" v-if="once">提交</div>
        </div>
        <div class="qrcode">
            <img src="https://cdn.juliye.net/2030_act_qrcode.jpeg" />
        </div>
        <div class="desc">点击提交后请加医生助理微信，完成报名</div>
        <div class="desc_2">祝您身体健康 生活愉快</div>
    </div>


    <div class="cover" v-if="isCover" v-on:click="closeCover">
        <div class="msg_card">{{msg}}</div>
    </div>

</div>
</body>
<script>
    new Vue({
        el:'#app',
        data:{
            isCover:false,
            msg:'请填写完整数据!',
            diseases:[],
            services:[],
            postData:{
                activity_id:'',
                recommended_user_id:'',
                user_id:'',
                diseases:'',
                services:'',
                name:'',
                phone:''
            },
            other_diseases:'',
            other_services:'',
            isOther:false,
            isOther2:false,
            once: false,

        },
        methods:{
            getConfig(){
                let that = this;
                that.$http
                    .get('/mc_weapp/product/activity/2/get_config')
                    .then(function (res) {
                        that.diseases = res.body.data.diseases;
                        that.services = res.body.data.services;

                    }, function (err) {
                        console.log(err);
                    });
            },
            changeDis(diseases){
                let that =this;
                if(diseases == '其他'){
                    that.isOther = true;
                }else{
                    that.isOther = false;
                }
            },
            changeSer(services){
                let that =this;
                if(services == '其他'){
                    that.isOther2 = true;
                }else{
                    that.isOther2 = false;
                }
            },
            upload(){
                let that = this;

                if(that.postData.diseases == '其他'){
                    that.postData.diseases = that.other_diseases
                }

                if(that.postData.services == '其他'){
                    that.postData.services = that.other_services
                }

                if(!that.postData.name || !that.postData.phone ||!that.postData.diseases || !that.postData.services){
                    that.isCover = true;
                    that.data = that.data;
                    return;
                }

                let upList = {
                    activity_id: that.postData.activity_id,
                    recommended_user_id:that.postData.recommended_user_id,
                    user_id:that.postData.user_id,
                    diseases: that.postData.diseases,
                    services: that.postData.services,
                    name: that.postData.name,
                    phone: that.postData.phone
                };
                that.$http
                    .post('/mc_weapp/product/activity/2/sign_up',upList)
                    .then(function (res) {
                        console.log(res);
                        // 更新当前数据
                        if(res.body.code == '200'){
                            that.once = true;
                            that.isCover = true;
                            that.msg = '提交成功';
                            that.data = that.data;
                            wx.miniProgram.navigateBack({
                                url:'/pages/recommend_goods/recommend_list/recommend_list?scene='+that.recommended_user_id
                            })
                        }else{
                            that.once = true;
                            that.isCover = true;
                            that.msg = res.body.msg;
                            that.data = that.data;
                        }
                    }, function (err) {
                        console.log(err);
                    });
            },
            closeCover(){
                let that = this;
                that.isCover = false;
                that.data = that.data;
            }

        },
        created(){
            let that = this;
            that.getConfig();
            var route = window.location.href;
            var localarr = route.split('?')[1].split('&');
            var tempObj = {};
            for (var i = 0; i < localarr.length; i++) {
                tempObj[localarr[i].split('=')[0]] = localarr[i].split('=')[1];
            }
            that.postData.activity_id = tempObj.activity_id;
            that.postData.recommended_user_id = tempObj.recommended_user_id;
            that.postData.user_id = tempObj.user_id;

            that.data = that.data;
        },
    })
</script>
</html>