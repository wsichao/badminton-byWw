<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- http://t.co/dKP3o1e -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    <meta name="format-detection" content="telephone=no"/>
    <title>额度详情</title>
    <link href="../general_file/general_css.css" rel="stylesheet" type="text/css"/>
    <link href="member_recharge.css" rel="stylesheet" type="text/css"/>


    <!-- Vue -->
    <!--<script src="lib/vue.min.js"></script>-->
    <!-- <script src="lib/vue-resource.min.js"></script>-->

    <script src="https://cdn.bootcss.com/vue/2.3.3/vue.min.js"></script>
    <script src="https://cdn.bootcss.com/vue-resource/1.3.1/vue-resource.min.js"></script>

    <script src="../general_file/general_js.js"></script>
</head>
<body>
    <div class="detail-content">
        <span id="noHistory" class="default position-center" v-if="isDefault">
            <img src="../dynamic/images/recent_non.png">
            <p>暂无详情</p>
        </span>
        <ul v-if="isContent">
            <li v-for="item in membershipList">
                <div class="money-top">
                    <span v-text="item.subTitle" class="money-left">共300元</span>
                    <span class="activities-gift" v-text="item.title"></span>
                    <span class="money-right" >剩余 <i v-text="item.balance"></i> <span> 元</span> </span>
                </div>

                <div  :class="[{ 'load-bar1': item.isFalse }, {'load-bar2' : !item.isFalse}]">
                    <div :class="[{ 'inner-load1': item.isFalse }, {'inner-load2' : !item.isFalse}]" :style="{width:item.width}"></div>
                </div>


                <div class="info">
                    <span v-text="item.validText"></span>
                    <i v-if="item.willExpire">即将到期</i>
                </div>
            </li>

        </ul>
        <div class="history-detail" v-if="isHistory">
            <button v-on:click="getHistory">过期额度></button>
        </div>
    </div>
</body>
</html>
<script src="../apply_doctor/lib/connectWebViewJavascriptBridge.js"></script>
<script>
    var webBridge = webViewBridge();
    webBridge.bridgeInit(function (bridge) {
        bridge.registerHandler('goBack', function (data,responseCallback) {
          var nativeData = {
            hideRight : false
          }
          webBridge.upload("hideRightBtn",nativeData);
            var result = {};
            result.isClose = false;
            responseCallback(JSON.stringify(result));
            window.history.back(-1);
        });
    });

    /* Vue.http.options.emulateJSON = true;*/
    var vm=new Vue({
        el:".detail-content",
        data:{
            userId : sessionStorage.getItem("userId"),
            token : sessionStorage.getItem("token"),
            membershipList : [],
            isDefault:false,
            isContent:true,
            isHistory:false
        },
        mounted:function(){
            this.$http({
                method: 'GET',
                url: "/1/customer/membershipList",
                headers : {
                    "x-docchat-user-id":this.userId,
                    "x-docchat-session-token":this.token
                }}).then(function (data) {
                if(data.body.historyCount){
                  this.isHistory = true
                }
                if(data.body.items.length == 0){
                    this.isDefault=true;
                    this.isContent=false;
                }else{
                    this.membershipList = data.body.items;
                    this.membershipList.forEach(function(item){
                        item.balance=Math.round((item.balance)* 100)/100;
                        if(item.cardNo=='2017050300000'){
                            item.title ="(历史额度迁移)";
                        }else{
                            item.title = '';
                        }
                        //item.balance = 0;
                        if(parseInt(item.balance) == 0){
                            item.isFalse = false;
                        }
                        else{
                            item.isFalse = true;
                        }
                        item.subTitle = "共" + item.totalVal + "元";
                        item.width = (item.balance/item.totalVal)*100 + "%";
                        item.validText = "有效期" + vm.getDotDate(item.validAt) + "-" + vm.getDotDate(item.expiredAt);
                        console.log(item.isFalse)
                    })
                    console.log(this.membershipList[0]);
                }
            },function(err){

                console.log("网络异常");
            })
            var nativeData = {
                hideRight : true
            }
            webBridge.upload("hideRightBtn",nativeData);
        },
        methods: {
            getHistory: function(){
                window.location="memberHistoryDetail.html";
            },
            getDotDate : function(dateNum){
                var date = new Date(dateNum);
                console.log(dateNum)
                var result = date.getFullYear() + "." + (date.getMonth() + 1) + "." + date.getDate();
                console.log(result);
                return result;
            },
            getDayDValue : function(expiredAt,validAt){
                var result = Math.ceil((expiredAt-validAt)/(1000 * 60 * 60 *24));
                return result;
            }

        }
    });
</script>

