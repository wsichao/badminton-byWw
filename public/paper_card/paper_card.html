<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>申请纸质名片</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="format-detection" content="telephone=no" />
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    <!-- JQuery -->
    <script src="https://cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script>
    <!-- Private -->
    <link href="../general_file/general_css.css" rel="stylesheet" type="text/css"/>
    <link href="paper_card.css" rel="stylesheet"/>
</head>
<body>
<div class="title">
    <h3>免费印刷，免费邮寄</h3>
</div>
<ul class="card-list">
    <li></li>
    <li>
        <span>收件人</span>
        <input type="text" placeholder="请输入" id="name"/>
    </li>
    <li></li>
    <li>
        <span>联系电话</span>
        <input type="text" placeholder="请输入" id="phoneNum"/>
    </li>
    <li></li>
    <li>
        <span>所在地区</span>
        <div id="position" class="position">请选择</div>
    </li>
    <li></li>
    <li>
        <span>详细地址</span>
        <div class="textarea" contenteditable="true" id="detailPosition"></div>
    </li>

</ul>
<div style="margin: 0 12px">
    <button class="gen-long-full-btn" id="submit">提交申请</button>
</div>

<p>提交成功后，我们将电话回复以进行确认，确认无误后会尽快将纸质名片邮寄到您手中。</p>
<div class="gray" style="display: none"></div>
<div class="alert" style="display: none">
    <button class="closeAlert" id="closeAlert" >
        <img src="https://cdn.juliye.net/btn_close@2x.png">
    </button>
    <ul class="position-list">
        <li>
            <select id="province">
                <option disabled selected value="">选择所在省</option>
            </select>
        </li>
        <li>
            <select id="city">
                <option disabled selected value="">选择所在市</option>
            </select>
        </li>
    </ul>


</div>
<script src="../apply_doctor/lib/connectWebViewJavascriptBridge.js"></script>
<script>
    $(function(){

        //绑定省市信息
        var provinceString='';
        var cityString='';
        $.ajax({
            type: "get",
            url: "/1/indexes/regions",
            success: function(rs){
                var area = rs;
                console.log(area);
                for(var i=0;i<area.length;i++){
                    provinceString=provinceString+"<option index='" + i + "' value='" + area[i].name + "'>" + area[i].name + "</option>";
                }
                $("#province").append(provinceString);
                //获取城市信息
                $("#province").change(function () {
                    $("#city").removeAttr("disabled");
                    areaIndex = $('#province').find('option:selected').attr('index');
                    $("#city").empty();
                    for(var j=0;j<area[areaIndex].subArea.length;j++) {
                        $("#city").append("<option index='" + j + "'  value='" + area[areaIndex].subArea[j].name + "'>" + area[areaIndex].subArea[j].name + "</option>")
                    }
                    //$("#city").change();
                    $("#city").on("change",function(){
                       // alert(this.text);
                        closeAlert();
                    });
                })

            },
            error: function(rs){
                alert("获取省份失败");
            }
        });



        window.alert = function(name){
            var iframe = document.createElement("IFRAME");
            iframe.style.display="none";
            iframe.setAttribute("src", 'data:text/plain,');
            document.documentElement.appendChild(iframe);
            window.frames[0].window.alert(name);
            iframe.parentNode.removeChild(iframe);
        }

        function getUrlQueryObject(){
            var query = decodeURIComponent(window.location.search.substring(1));
            var urlArray = query.split('&'),queryObj = {};
            urlArray.forEach(function(item){
                var itemArray =  item.split('=');
                queryObj[itemArray[0]] = itemArray[1];
            })
            return queryObj;
        }
        var urlData=getUrlQueryObject();
        console.log(urlData);
        var wordLength=10;
        if(urlData.name){
            urlData.name=urlData.name.slice(0,wordLength);
            $("#name").val(urlData.name);
        }
        $("#phoneNum").val(urlData.phoneNum);

        //处理名字只能为10个字
        var input=$("#name");
        input.on('input',function(e){
            var value=this.value;
            if(value.length>=wordLength){
                this.value=value.slice(0,wordLength);
            }

        });


        var $position=$("#position");
        var $gray=$('.gray');
        var $alertWindow=$('.alert');
        if($position.text()=="请选择"){
            $position.css("color","#b3b3b3");
        }


        function closeAlert(){
            $gray.hide();
            $alertWindow.hide();
            var province=$("#province").val();
            var city=$("#city").val();
            if(province!=null && city!=null){
                $position.text(province+" "+city);

            }else if(province!=null && city==null){
                $position.text(province);
            }
            if($position.text()!="请选择"){
                $position.css("color","#000");
            }
        }

        $('.closeAlert').click(closeAlert);
        $gray.click(closeAlert);

        $position.click(function(){
            $gray.show();
            $alertWindow.show();
        });

        $("#submit").click(function(){
            if($("#name").val()==""){
                alert("请输入收件人");
                return;
            }
            if($("#phoneNum").val()==""){
                alert("请输入联系电话");
                return;
            }
            if($("#phoneNum").val().length!=11 && $("#phoneNum").val().length != 12){
                alert('请输入正确的电话号');
                return;
            }
            if($("#position").text()=="" || $("#position").text().indexOf("请选择")!=-1){
                alert("请输入所在地区");
                return;
            }
            if($("#detailPosition").text()==""){
                alert("请输入详细地址");
                return;
            }
            var postData={};
            postData.receiveName=$("#name").val();
            postData.receivePhone=$("#phoneNum").val();
            postData.receiveArea=$("#position").text();
            postData.receiveAddress=$("#detailPosition").text();
            console.log(postData);
            //=====测试数据======
           /* urlData.userId='583508e70b6b3ac26a65468b';
            urlData.token='5CD0680D8A835A8A78C819C50897A211';*/
            $.ajax({
                type: "POST",
                url:"/1/customer/cardApply",
                data: JSON.stringify(postData),
                dataType:'json',
                headers : {
                    "Content-Type": 'application/json',
                    "x-docchat-user-id":urlData.userId,
                    "x-docchat-session-token":urlData.token
                },
                success: function(rs){
                    var webBridge = webViewBridge();
                    webBridge.bridgeInit(function (bridge) {});
                    webBridge.upload('submitSuc');
                },
                error: function(rs){
                    alert("提交失败，请重试！");
                }

            });


        });



    });



</script>

</body>
</html>