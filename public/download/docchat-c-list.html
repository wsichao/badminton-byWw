<html lang="en">
<head>
    <meta charset="utf-8">
    <title>朱李叶健康</title>
    <!--<base href="/download/">-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimal-ui">
    <meta name="apple-mobile-web-app-status-bar-style" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="description" content="医聊">
    <link rel="icon" type="image/x-icon" href="./images/logo_c.png">
    <link rel="stylesheet" type="text/css" href="styles/docchat-c.css">
    <!-- JQuery -->
    <script src="https://cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>

</head>
<style>
    * {
        margin: 0px;
        padding: 0px
    }
    ::-webkit-input-placeholder { /* WebKit browsers */
        　　color:#535353;
    }
    a{
        text-decoration: none;
    }
    body{
        width:100%;
        height:100%;
        position: relative;
        font-family:Helvetica;
    }
</style>

<body>
<div id="contant" style=" width: 100%;">
    <p class="document">输入手机号、姓名即可关注下列医生，之后有相关的问题，可以通过“朱李叶健康”随时随地问医生，医生的动态也将以短信的方式发送至你手机。</p>


    <div style="margin:12px 12px;">
        <input class="inputphone" type="text" placeholder="请输入姓名" id="customerName">
    </div>
    <div style="margin:12px 12px;">
        <input class="inputphone" type="number" placeholder="请输入手机号" id="customerPhone">
    </div>
    <div style="margin: 12px;">
        <button id="concernBtn">一键关注</button>
    </div>
    <div class="doc-list" id="docList">

    </div>

    <div class="footer">
    </div>
    <img class="logo" src="images/logo_c.png" />
    <span class="zly">朱李叶健康</span>
    <a class="down-load" href="http://a.app.qq.com/o/simple.jsp?pkgname=com.zlycare.docchat.c">
        立即下载
    </a>
</div>
<div class="gray" style="display: none">
</div>
<div class="alert" id="concernSuccessAlert" style="display: none">
    <div class="msg">
        <h4>关注成功!</h4>
        <p>你已成功关注<span id="alertName">这组医生</span>,可以直接下载朱李叶健康给他打电话啦！</p>
    </div>
    <div class="alertBtn">
        <button class="cancel">取消</button>
        <a href="http://a.app.qq.com/o/simple.jsp?pkgname=com.zlycare.docchat.c" class="download-App">下载App</a>
    </div>

</div>
<div class="alert" id="phoneMsgCode" style="padding-bottom: 20px;height: auto;display: none" >
    <button id="closeAlert">
        <img src="images/btn_close@2x.png">
    </button>
    <!--<h4 style="text-align: center;font-size: 18px;margin-top: 20px;font-weight: 100">&nbsp; 验证码</h4>-->
    <div style="padding: 0 30px;margin-top:18px;">
        <input type="text" id="msgCodeInput" placeholder="请输入短信验证码">
        <button id="confirmMsgCode">确认</button>
    </div>
    <p class="errorMsg" id="error" style="display: none">验证码错误，请重新输入</p>
</div>


<div id="tishi" class="tishi">
    <img src="images/02.png"/>
</div>

<script>
    $(function () {
        document.getElementById("contant").style.height = window.innerHeight;
        console.log(window.innerWidth);
    });
    var HOST = 'https://pro.mtxhcare.com';
    //if(window.location.hostname!="api.dc.zlycare.com"){
    var REG = /test/;
    //if(window.location.hostname!="dc-c.zlycare.com"){
    if (REG.test(window.location.hostname)){
        HOST = 'https://dev.mtxhcare.com';
    }


    //更新医师信息
    $(function () {
        var params = location.search; //获取url中"?"符后的字串
        docGrpId = params.split('=')[1];
        if (docGrpId) {
            console.log( '/1/doctor/infoByDocGrpId?docGrpId=' + docGrpId)
            $.ajax({
                url: '/1/doctor/infoByDocGrpId?docGrpId=' + docGrpId,
                type: 'GET',
                success: function (result) {
                    Doctor = result;
                    updateDoctorInfo(Doctor);
                    console.log(Doctor);
                },
                error:function(){
                    console.log("err");
                }
            });
        }else{
            console.log("does'n have docGrpId")
        }
    });

    //点击关注顾问按钮
    $(function(){
        $("#concernBtn").click(function(){
            var reg = /^(13|15|18|17)[0-9]{9}$/;
            var phoneNum = $("#customerPhone").val();
            var name = $("#customerName").val();
            console.log(phoneNum)
            if(phoneNum=="" || !reg.test(phoneNum)){
                alert('请输入正确的手机号');
                return;
            }
            if(name==""){
                alert('请输入姓名');
                return;
            }

            $.ajax({
                url: '/1/common/authCode?phoneNum=' + phoneNum + '&from=favoriteDoc&token=true',
                type: 'GET',
                success: function (result) {
                    console.log("获取验证码成功");
                    $(".gray").show();
                    $("#phoneMsgCode").show();
                    $("#confirmMsgCode").focus();
                }
            });
        })
    })
    //点击×
    $(function(){
        $("#closeAlert").click(function(){
            $(".gray").hide();
            $("#phoneMsgCode").hide();
            $("#error").hide();
            $("#msgCodeInput").val("");
        })
    })
    //点击关注成功的取消
    $(function(){
        $(".cancel").click(function(){
            $("#concernSuccessAlert").hide();
            $(".gray").hide();
            $("#msgCodeInput").val("");
        })
    })
    //确认短信验证码按钮状态
    $(function () {
        if($("#msgCodeInput").val()==""){
            $("#confirmMsgCode").attr("disabled","disabled");
        }
        $("#msgCodeInput").keypress(function(){
            $("#confirmMsgCode").removeAttr("disabled");
        })
    })
    //点击确认短信验证码批量关注医生
    $(function(){
        $("#confirmMsgCode").click(function(){
            var data ={};
            data.authCode = $("#msgCodeInput").val();
            data.phoneNum = $("#customerPhone").val();
            data.name = $("#customerName").val();
            var params = location.search; //获取url中"?"符后的字串
            if (params) {
                data.docGrpId = params.split('=')[1];
            }
            console.log(JSON.stringify(data));
            $.ajax({
                url: '/1/customer/msgFollowDocs',
                type: 'POST',
                data: JSON.stringify(data),
                dataType:'json',
                headers : {
                    "Content-Type": 'application/json'
                },
                success: function (result) {
                    console.log("关注成功");
                    $("#phoneMsgCode").hide();
                    $("#concernSuccessAlert").show();
                    $("#error").hide();
                },
                error: function (err) {
                    console.log(err);
                    if( JSON.parse(err.responseText).code != 1502){
                        $("#error").text("请求失败")
                    }else{
                        $("#error").text("验证码错误请重新输入")
                    }
                    $("#error").show();
                }
            });
        })
    })
    var isWX = function () {
        var ua = navigator.userAgent.toLowerCase();
        if (ua.match(/MicroMessenger/i) == "micromessenger") {
            return true;
        } else {
            return false;
        }

    };

    var Doctor;

    var updateDoctorInfo = function (doctor) {
        for(var i = 0;i<doctor.list.length;i++){
            $("<div></div>").appendTo("#docList").addClass("doc-item").attr("id", "doc" + i);
            $("<div style='float:left'></div>").appendTo("#doc" + i)
                    .append("<img class='img-rounded' style='width:54px;height: 54px;border-radius: 27px' id='avatar" + i + "'/>")
            if(doctor.list[i].avatar && doctor.list[i].avatar.toString().indexOf("avatar")){
                $("#avatar"+i).attr("src","https://cdn.juliye.net/" + doctor.list[i].avatar + "?imageView2/2/w/80/h/80");
            }else{
                if(doctor.list[i].sex){
                    if(doctor.list[i].sex=="女"){
                        $("#avatar"+i).attr("src","images/img_headportrait_lady@3x.png");
                    }else{
                        $("#avatar"+i).attr("src","images/img_headportrait_man@3x.png");
                    }
                }else{
                    $("#avatar"+i).attr("src","images/img_headportrait_man@3x.png");
                }

            }
            $("<div style='float:left;margin-left: 12px;padding-top:6px;'></div>").appendTo("#doc" + i)
                    .append("<div><span class='name' >" + doctor.list[i].realName + "&nbsp;</span><span class='phone'>" + doctor.list[i].docChatNum + "</span></div>")
                    .append("<div><ul><li style='list-style-type:none;margin-top: 8px;'><span class='docInfo' id='department" + i + "'>" + doctor.list[i].department +
                            "</span><span id='divider" + i + "'>&nbsp;|&nbsp;</span><span  class='docInfo' id='position" + i + "'>" + doctor.list[i].position +
                            "</span></li><li style='list-style-type:none;margin-top:8px'><span  class='companyInfo' id='hospital" + i + "'>" + doctor.list[i].hospital +"</span></li></ul></div>")

            $(".document").text(doctor.description)
            if(doctor.list[i].department =="" && doctor.list[i].position ==""){
                $("#department"+i).hide();
                $("#divider"+i).hide();
                $("#position"+i).hide();
            }else{
                if(doctor.list[i].department ==""){
                    $("#department"+i).hide();
                    $("#divider"+i).hide();
                }
                if(doctor.list[i].position ==""){
                    $("#position"+i).hide();
                    $("#divider"+i).hide();
                }
            }
            if(doctor.list[i].hospital==""){
                $("#hospital"+i).hide()
            }
        }

    };
//    var getCoupon = function () {
//        var phone = document.getElementById("phoneNum").value;
//
//        if (phone.length != 11) {
//            document.getElementById("errorTips").innerHTML = '您输入的手机号码有误';
//            return;
//        }
//
//        document.getElementById("errorTips").innerHTML = '  ';
//        $.ajax({
//            url: HOST + '/1/operation/getCoupon?phoneNum=' + phone + (Doctor ? ('&docChatNum=' + Doctor.docChatNum) : ''),
//            type: 'GET',
//            success: function (result) {
//                document.getElementById("getCoupon").style.display = 'none';
//                document.getElementById("getCouponSuccess").style.display = 'inline';
//            },
//            error: function (err) {
//                document.getElementById("errorTips").innerHTML = '您已领取了代金券';
//            }
//        });
//    };

</script>
</body>
</html>
