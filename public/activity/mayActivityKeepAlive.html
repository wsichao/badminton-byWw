<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- http://t.co/dKP3o1e -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    <meta name="format-detection" content="telephone=no" />
    <title>领券活动</title>
    <link href="../general_file/general_css.css" rel="stylesheet" type="text/css" />
    <link href="activity.css" rel="stylesheet" type="text/css"/>


    <!-- Vue -->
    <script src="https://cdn.bootcss.com/vue/2.3.3/vue.min.js"></script>
    <script src="https://cdn.bootcss.com/vue-resource/1.3.1/vue-resource.min.js"></script>
    <script src="../general_file/general_js.js"></script>

    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?5402d444962caaeb2486c98f3a005af9";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();

    </script>

</head>
<body>
    <div class="mayActivity">
        <div>
            <img src="http://7j1ztl.com1.z0.glb.clouddn.com/WechatIMG17.png"/>
        <div>
        <div class="figure">
            <div class="coupon-out">
                <img src="http://7j1ztl.com1.z0.glb.clouddn.com/WechatIMG5.png" />
            </div>
            <div class="success" v-show="shareSuccess" style="display: none">领取成功</div>
            <div class="button-out">
                <button v-show="!shareSuccess" v-on:click="share">
                    分享好友 &nbsp;&nbsp;立即领取
                </button>
                <button v-show="shareSuccess" style="display: none" v-on:click="use">
                    立即使用
                </button>
            </div>
            <div v-show="shareSuccess" class="success-sub" style="display: none">点击 "我" - "我的钱包" 查看</div>
        </div>
        <div class="may-rules" style="background: #FFFFFF;color: #000000">
            <h3 style="font-family: RTWSYUEGOTRIAL-REGULAR">活动规则:</h3>
            <ul>
                <li>1、本活动5元通用券仅适用于会员专区商户，仅限会员领取，至少5元额度可以领取</li>
                <li>2、同一用户仅限领取1张，同一账户、手机号码、支付账户等均视为同一用户</li>
                <li>3、本次活动参与用户需将本活动分享到微信或朋友圈才可领取，分享后优惠券自动到账</li>
                <li>4、任何非正常购买到行为，均视为作弊行为，本公司有权取消会员资格</li>
                <li>5、法律允许范围内，解释权归本公司所有</li>
            </ul>
        </div>
        <div v-if="isLoading">
            <div class="gen-gray-back"  id="gray"></div>
            <div class="alert" style="padding:15px; width:170px; background-color:rgba(255,255,255,0.0)" id="suc_alert">
                <div class="cushion">
                    <img src="../apply_doctor/images/Loading@3x@3x.png" id="change">
                </div>
            </div>
        </div>
        <div v-show="showAlert" class="errAlert"  style="border-radius:8px;background: #f6f6f6">
            <div>
                <img src="http://7j1ztl.com1.z0.glb.clouddn.com/WechatIMG20.png" />
            </div>
            <div v-on:click="buy">
                <img src="http://7j1ztl.com1.z0.glb.clouddn.com/WechatIMG19.png" />
            </div>
        </div>
    </div>
<script src="../apply_doctor/lib/connectWebViewJavascriptBridge.js"></script>
<script>

    var data = '<%-data%>';
    data = data.replace(new RegExp("\r\n", "gm"), "\\r\\n");
    data = data.replace(new RegExp("\n\r", "gm"), "\\n\\r");
    data = data.replace(new RegExp("\n", "gm"), "\\n");
    data = data.replace(new RegExp("\'", "gm"), " ");
    data = JSON.parse(data);
    console.log(data);
    var vm = new Vue({
        el:".mayActivity",
        data:{
            isLoading:false,
            shareSuccess:false,
            showAlert:false
        },
        mounted:function(){
          if(data.hasCoupon){
            this.shareSuccess = true;
          }
        },
        methods:{
            share: function(){
                var HOST = 'http://web.dc.zlycare.com';
                var REG = /test/;
                //if(window.location.hostname!="dc-c.zlycare.com"){
                if (REG.test(window.location.hostname)){
                    HOST = 'http://web.dc-test.zlycare.com';
                }else if(! /zlycare.com/.test(window.location.hostname)){
                    HOST = 'http://192.168.3.65:9020';
                }
                var dataShare = {
                    title: '我有一个5元红包待你领取，下载APP充25得300元！',
                    desc: '24全城购,花25得300优惠额度，全城领券，优惠不停。',
                    img:'http://7j1ztl.com1.z0.glb.clouddn.com/WechatIMG23.png',
                    url: HOST + "/activity/mayActivityKeepAliveOut.html"
                }
                /*alert(dataShare.url);*/
                console.log(dataShare);
                webBridge.upload("shareCoupon",JSON.stringify(dataShare));
            },
            buy: function(){
                urlString="userId="+data.userId+"&token="+data.token+"&client="+data.client+"&isVersionPass="+data.isVersionPass;
                window.location.href="../member-recharge/memberRechargeNew.html?"+urlString;
            },
            use: function(){
                webBridge.upload("gotoVIP");
            },
            getCoupon: function(){
              this.$http({
                method: 'GET',
                url: '/1/activity/share/getCoupon170526',
                headers: {
                  "x-docchat-user-id":data.userId,
                  "x-docchat-session-token":data.token
                }
              }).then(function(rs){
                vm.isLoading=false;
                vm.shareSuccess = true;

              },function(err){
                if(err.body) {
                  var err=err.body;
                  vm.isLoading=false;
                  var code = err.code;
                  console.log(code);
                  if (code == "2202") {
                    alert("优惠券被领完啦");
                  }else if(code == "2109"){
                    vm.isLoading = true;
                    vm.showAlert = true;
                  }else if(code == "1531"){
                    alert("您已经领取过");
                    vm.shareSuccess = true;
                  }else if(code =='2115'){
                    alert("同一设备只能领取一次")
                  }
                  else{
                    alert("领取失败");
                  }
                }else{
                  alert("领取失败");
                }
              });
            },
            cancel: function(){
              vm.showAlert=false;
            }
        }
    });
    var webBridge = webViewBridge();
    webBridge.bridgeInit(function (bridge) {
        bridge.registerHandler('shareSuc', function (data,responseCallback){
            vm.isLoading=true;
            setTimeout(vm.getCoupon(),2000);
        });
        bridge.registerHandler('goBack', function (data,responseCallback) {
            var result = {};
            result.isClose = true;
            responseCallback(JSON.stringify(result));
        });
    });
</script>
</body>
</html>