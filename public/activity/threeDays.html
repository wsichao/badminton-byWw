<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- http://t.co/dKP3o1e -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">

    <title>24全城购－三天三夜</title>
    <link href="../general_file/general_css.css" rel="stylesheet"
          type="text/css" />
    <link href="activity.css" rel="stylesheet" type="text/css" />
    <!-- JQuery -->
    <script src="http://7j1ztl.com1.z0.glb.clouddn.com/jquery-2.1.4.min.js"></script>
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ee4447c3cfabb8196e540d006e43266b";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
</head>
<body>

<img src="http://7j1ztl.com1.z0.glb.clouddn.com/41.1.png" class="top"
     id="topBackground"  >
<div class="content" style="padding-bottom: 0">
    <div class="share-button three-btn-background" id="getCouponButton">
        <img src="http://7j1ztl.com1.z0.glb.clouddn.com/1.2.1.png" class="shareBtn" id="getCoupon">
        <fieldset style="margin-top:-20px;">
            <legend> 会员专区所有活动都可使用 </legend>
        </fieldset>

    </div>
    <div class="share-button three-btn-background2" id="shareButton" style="display: none;">
        <img src="http://7j1ztl.com1.z0.glb.clouddn.com/%E5%88%86%E4%BA%AB%E5%86%8D%E9%A2%868%E5%85%83.png" class="shareBtn" id="share" style="width:50%; margin:0 auto; display: block"/>
        <fieldset  style="margin-top:15px;">
            <legend> 会员专区所有活动都可使用 </legend>
        </fieldset>
    </div>
    <div class="share-button three-btn-background2"  id="useButton" style="display: none;">
        <img  src="http://7j1ztl.com1.z0.glb.clouddn.com/%E7%AB%8B%E5%8D%B3%E4%BD%BF%E7%94%A8.png" class="shareBtn" id="use"
              style="width:50%; margin:0 auto; display: block">
        <fieldset style="margin-top:15px;">
            <legend> 会员专区所有活动都可使用 </legend>
        </fieldset>
    </div>

</div>
<img src="http://7j1ztl.com1.z0.glb.clouddn.com/1.3.png"  class="top">
<div class="three-days-list">
    <h2>活动规则：</h2>
    <ul>
        <li>
            1.会员专区所有商户都可使用。
        </li>
        <li>
            2.本次活动针对保定，烟台，南和，燕郊，牡丹江，唐山，沧州7个城市指定商户使用。
        </li>
        <li>
            3.本次代金券不设找零，不可挂失，每个用户每天限使用一次。
        </li>
        <li>
            4.同一设备，手机号，支付账号视为同一个用户，每张券限用一次。
        </li>
        <li>
            5.法律允许范围内，解释权归朱李叶健康所有。
        </li>
    </ul>
</div>
<div class="gen-gray-back filter"  style="display:none" id="gray"></div>
<div class="alert" style="padding:15px; width:170px; background-color:rgba(255,255,255,0.0);display:none" id="suc_alert">

    <div class="cushion">
        <img src="../apply_doctor/images/Loading@3x@3x.png" id="change">
    </div>

</div>
<script
        src="../advertising/lib/connectWebViewJavascriptBridge.js"></script>
<script>
    $(function() {
        window.alert = function (name) {
            var iframe = document.createElement("IFRAME");
            iframe.style.display = "none";
            iframe.setAttribute("src", 'data:text/plain,');
            document.documentElement.appendChild(iframe);
            window.frames[0].window.alert(name);
            iframe.parentNode.removeChild(iframe);
        };
        var data = '<%-data%>';
        data = data.replace(new RegExp("\r\n", "gm"), "\\r\\n");
        data = data.replace(new RegExp("\n\r", "gm"), "\\n\\r");
        data = data.replace(new RegExp("\n", "gm"), "\\n");
        data = data.replace(new RegExp("\'", "gm"), " ");
        var initData = JSON.parse(data);
        var webBridge = webViewBridge();
        var rs = initData.membership || {};
        console.log(rs)
        // alert(rs.isTriDayShareRewardReceived);
        //rs.isTriDayShareRewardReceived=true;
        //rs.isTriDayRewardReceived=true;
        if(rs.isTriDayShareRewardReceived == true || rs.isTriDayRewardReceived == true){
            if(rs.isTriDayShareRewardReceived == true){//领了8元券
                $("#topBackground").attr("src","http://7j1ztl.com1.z0.glb.clouddn.com/3.png");
                $("#shareButton").hide();
                $("#useButton").show();
                $("#getCouponButton").hide();

            }else{//没领8元券
                $("#topBackground").attr("src","http://7j1ztl.com1.z0.glb.clouddn.com/131157625544768451.png");
                $("#getCouponButton").hide();
                $("#shareButton").show();
                $("#useButton").hide();
            }

        }else{//没领券
            $("#shareButton").hide();
            $("#useButton").hide();
            $("#getCouponButton").show();
        }

        webBridge.bridgeInit(function (bridge) {
            bridge.registerHandler('shareSuc', function (data,responseCallback){
                $("#gray").show();
                $(".alert").show();
                setTimeout(function(){
                $.ajax({
                    type: "GET",
                    url: "/1/customer/getCouponConsumedMembershipByShare",
                    headers: {
                        "x-docchat-user-id":initData.userId,
                        "x-docchat-session-token":initData.token
                    },
                    success: function(rs){
                        $("#gray").hide();
                        $(".alert").hide();
                        $("#topBackground").attr("src","http://7j1ztl.com1.z0.glb.clouddn.com/3.png");
                        $("#shareButton").hide();
                        $("#useButton").show();
                        $("#getCouponButton").hide();
                    },
                    error:function(err){
                        $("#gray").hide();
                        $(".alert").hide();
                        if(err.responseText){
                            var errData=JSON.parse(err.responseText);
                            if(errData.code == 1604){
                                alert("已领取过");
                                $("#topBackground").attr("src","http://7j1ztl.com1.z0.glb.clouddn.com/3.png");
                                $("#shareButton").hide();
                                $("#useButton").show();
                                $("#getCouponButton").hide();
                            }else if(errData.code == 2109){
                                alert("您的会员额度不足，请到朱李叶健康“我”-“我的会员”购买会员额度");
                            }else if(errData.code == 2115){
                                alert("当前设备已领取过此优惠");
                            }
                            }else{
                                $("#shareButton").show();
                                $("#useButton").hide();
                                $("#getCouponButton").hide();
                            }

                    }
                });
                },2000);
            });
        });
        // Todo: @yangxiao 加多次点击限制
        $("#getCoupon").click(function(e){//领券按钮

            $("#gray").show();
            $(".alert").show();
            $.ajax({
                type: "GET",
                url: "/1/customer/getCouponConsumedMembership",
                headers: {
                    "x-docchat-user-id":initData.userId,
                    "x-docchat-session-token":initData.token
                },
                success: function(rs){
                    $(".alert").hide();
                    $("#gray").hide();
                    console.log(rs);
                    $("#topBackground").attr("src","http://7j1ztl.com1.z0.glb.clouddn.com/131157625544768451.png");
                    $("#getCouponButton").hide();
                    $("#shareButton").show();
                    $("#useButton").hide();
                },
                error:function(err){
                    console.log(err);
                    $(".alert").hide();
                    $("#gray").hide();
                    if(err.responseText){
                        if(JSON.parse(err.responseText).code == 1604){
                            alert("已领取过");
                            $("#topBackground").attr("src","http://7j1ztl.com1.z0.glb.clouddn.com/131157625544768451.png");
                            $("#getCouponButton").hide();
                            $("#shareButton").show();
                            $("#useButton").hide();
                        }else if(JSON.parse(err.responseText).code == 2109){
                            alert("您的会员额度不足，请到朱李叶健康“我”-“我的会员”购买会员额度");
                        }else if(JSON.parse(err.responseText).code == 2115){
                            alert("当前设备已领取过此优惠");
                        }else{
                            $("#topBackground").attr("src","http://7j1ztl.com1.z0.glb.clouddn.com/41.1.png");
                            $("#getCouponButton").show();
                            $("#shareButton").hide();
                            $("#useButton").hide();
                        }
                    }else{
                        $("#topBackground").attr("src","http://7j1ztl.com1.z0.glb.clouddn.com/41.1.png");
                        $("#getCouponButton").show();
                        $("#shareButton").hide();
                        $("#useButton").hide();
                    }


                }
            })
        })

        var HOST = 'http://web.dc.zlycare.com';
        var REG = /test/;
        //if(window.location.hostname!="dc-c.zlycare.com"){
        if (REG.test(window.location.hostname)){
            HOST = 'http://web.dc-test.zlycare.com';
        }else if(! /zlycare.com/.test(window.location.hostname)){
            HOST = 'http://192.168.3.65:9020';
        }
        $("#share").click(function(){

            var dataShare = {
                title: '送你21元消费红包',
                desc: '好消息我只跟你说，给你21元，3天3夜免费白拿',
                img:'http://7j1ztl.com1.z0.glb.clouddn.com/icon_share_0421.png',
                url: HOST + "/activity/threeDays_out.html"
            }
            console.log(dataShare);
            webBridge.upload("shareCoupon",JSON.stringify(dataShare));
        });

        $("#useButton").click(function(){
            webBridge.upload("gotoVIP");
        });

    });
</script>
</body>
</html>